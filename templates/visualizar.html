{% extends "base.html" %}

{% block title %}Boleto {{ boleto.code }} - Consulta de Boletos Cora{% endblock %}

{% block extra_css %}
<style>
    /* Responsividade para mobile */
    @media (max-width: 768px) {
        .card > div:first-child {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .card > div:first-child h2 {
            font-size: 1.3em;
        }
        
        .card > div:first-child .btn {
            width: 100%;
        }
        
        /* Grids responsivos */
        div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
        }
        
        /* Status box */
        div[style*="background: #f0fdf4"],
        div[style*="background: #fef3c7"] {
            padding: 16px !important;
        }
        
        div[style*="background: #f0fdf4"] > div,
        div[style*="background: #fef3c7"] > div {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 10px !important;
        }
        
        /* QR Code */
        img[alt="QR Code PIX"] {
            max-width: 250px !important;
            width: 100% !important;
        }
        
        /* Bot√µes */
        button[onclick*="copyToClipboard"] {
            width: 100% !important;
            margin-top: 10px !important;
        }
        
        /* Textos longos */
        p[style*="word-break: break-all"],
        div[style*="word-break: break-all"] {
            font-size: 0.85em !important;
            padding: 12px !important;
        }
        
        /* Data de vencimento destacada */
        div[style*="background: linear-gradient(135deg"] {
            padding: 16px !important;
        }
        
        div[style*="background: linear-gradient(135deg"] > div {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 10px !important;
        }
        
        div[style*="background: linear-gradient(135deg"] p {
            font-size: 1.2em !important;
        }
        
        div[style*="background: linear-gradient(135deg"] div[style*="font-size: 2.5em"] {
            font-size: 2em !important;
        }
        
        /* Info boxes */
        .info-box {
            padding: 16px !important;
        }
        
        .info-box h4 {
            font-size: 1em !important;
        }
        
        /* Se√ß√µes */
        h3 {
            font-size: 1.2em !important;
        }
    }
    
    @media (max-width: 480px) {
        .card > div:first-child h2 {
            font-size: 1.1em;
        }
        
        img[alt="QR Code PIX"] {
            max-width: 200px !important;
        }
        
        div[style*="background: linear-gradient(135deg"] p {
            font-size: 1.1em !important;
        }
        
        p[style*="word-break: break-all"],
        div[style*="word-break: break-all"] {
            font-size: 0.8em !important;
            letter-spacing: 0.5px !important;
        }
        
        h3 {
            font-size: 1.1em !important;
        }
        
        .info-box h4 {
            font-size: 0.95em !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <h2 style="color: #E0367E; font-weight: 700;">Detalhes do Boleto</h2>
        <a href="javascript:history.back()" class="btn btn-secondary" style="flex-shrink: 0;">‚Üê Voltar</a>
    </div>
    
    <!-- Status do Pagamento -->
    <div style="margin-bottom: 30px; padding: 24px; background: {% if boleto.esta_pago %}#f0fdf4{% else %}#fef3c7{% endif %}; border-radius: 16px; border-left: 4px solid {% if boleto.esta_pago %}#16a34a{% else %}#f59e0b{% endif %};">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <span class="status-badge status-{{ boleto.status.lower() if boleto.status else 'pending' }}">
                {% if boleto.esta_pago %}
                    ‚úÖ PAGO
                {% else %}
                    {% if boleto.status == 'PENDING' %}
                        ‚è≥ PENDENTE
                    {% elif boleto.status == 'LATE' %}
                        ‚ö†Ô∏è VENCIDO
                    {% elif boleto.status == 'CANCELLED' %}
                        ‚ùå CANCELADO
                    {% else %}
                        üìã {{ boleto.status }}
                    {% endif %}
                {% endif %}
            </span>
            <span style="color: #666; font-size: 1.1em;">
                {% if boleto.esta_pago %}
                    Este boleto foi pago.
                {% else %}
                    Este boleto ainda n√£o foi pago.
                {% endif %}
            </span>
        </div>
    </div>
    
    <!-- Dados do Cliente -->
    {% if boleto.customer %}
    <div style="margin-bottom: 30px;">
        <h3 style="color: #E0367E; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; font-weight: 700;">üë§ Dados do Cliente</h3>
        <div class="info-box">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                {% if boleto.customer.get('name') %}
                <div>
                    <strong style="color: #666; font-size: 0.9em;">Nome:</strong>
                    <p style="margin-top: 5px; font-size: 1.1em; color: #333; word-break: break-word;">{{ boleto.customer.name }}</p>
                </div>
                {% endif %}
                {% if boleto.customer.get('document') %}
                    {% if boleto.customer.document is mapping %}
                        {% if boleto.customer.document.get('identity') %}
                        <div>
                            <strong style="color: #666; font-size: 0.9em;">CPF/CNPJ:</strong>
                            <p style="margin-top: 5px; font-size: 1.1em; color: #333;">{{ boleto.customer.document.identity }}</p>
                        </div>
                        {% endif %}
                        {% if boleto.customer.document.get('type') %}
                        <div>
                            <strong style="color: #666; font-size: 0.9em;">Tipo:</strong>
                            <p style="margin-top: 5px; font-size: 1.1em; color: #333;">{{ boleto.customer.document.type }}</p>
                        </div>
                        {% endif %}
                    {% else %}
                    <div>
                        <strong style="color: #666; font-size: 0.9em;">CPF/CNPJ:</strong>
                        <p style="margin-top: 5px; font-size: 1.1em; color: #333;">{{ boleto.customer.document }}</p>
                    </div>
                    {% endif %}
                {% endif %}
                {% if boleto.customer.get('email') %}
                <div>
                    <strong style="color: #666; font-size: 0.9em;">Email:</strong>
                    <p style="margin-top: 5px; font-size: 1.1em; color: #333;">{{ boleto.customer.email }}</p>
                </div>
                {% endif %}
                {% if boleto.customer.get('address') %}
                    {% set addr = boleto.customer.address %}
                    <div style="grid-column: 1 / -1;">
                        <strong style="color: #666; font-size: 0.9em;">Endere√ßo:</strong>
                        <p style="margin-top: 5px; font-size: 1.1em; color: #333;">
                            {% if addr.get('street') %}{{ addr.street }}{% endif %}{% if addr.get('number') %}, {{ addr.number }}{% endif %}
                            {% if addr.get('complement') %}, {{ addr.complement }}{% endif %}<br>
                            {% if addr.get('district') %}{{ addr.district }}{% endif %}{% if addr.get('city') %}, {{ addr.city }}{% endif %}{% if addr.get('state') %} - {{ addr.state }}{% endif %}
                            {% if addr.get('zip_code') %}<br>CEP: {{ addr.zip_code }}{% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Informa√ß√µes do Boleto -->
    <div style="margin-bottom: 30px;">
        <h3 style="color: #E0367E; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; font-weight: 700;">üìã Informa√ß√µes do Boleto</h3>
        <div class="info-box">
            <div style="display: flex; flex-direction: column; gap: 20px;">
                {% if boleto.due_date %}
                <div style="padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <div style="flex: 1; min-width: 200px;">
                            <strong style="color: #92400e; font-size: 0.95em; display: block; margin-bottom: 8px; font-weight: 600;">Data de Vencimento</strong>
                            <p style="font-size: 1.5em; color: #78350f; font-weight: 700; margin: 0;">{{ boleto.due_date[:10] if boleto.due_date|length > 10 else boleto.due_date }}</p>
                        </div>
                        <div style="font-size: 2.5em; flex-shrink: 0;">üìÖ</div>
                    </div>
                </div>
                {% endif %}
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    {% if boleto.id %}
                    <div>
                        <strong style="color: #666; font-size: 0.9em; display: block; margin-bottom: 6px;">ID:</strong>
                        <p style="font-size: 1em; color: #333; word-break: break-all;">{{ boleto.id }}</p>
                    </div>
                    {% endif %}
                    {% if boleto.code %}
                    <div>
                        <strong style="color: #666; font-size: 0.9em; display: block; margin-bottom: 6px;">C√≥digo:</strong>
                        <p style="font-size: 1em; color: #333;">{{ boleto.code }}</p>
                    </div>
                    {% endif %}
                    {% if boleto.valor_formatado %}
                    <div>
                        <strong style="color: #666; font-size: 0.9em; display: block; margin-bottom: 6px;">Valor:</strong>
                        <p style="font-size: 1.1em; color: #333; font-weight: 600;">{{ boleto.valor_formatado }}</p>
                    </div>
                    {% endif %}
                    {% if boleto.esta_pago and boleto.data_pagamento %}
                    <div>
                        <strong style="color: #666; font-size: 0.9em; display: block; margin-bottom: 6px;">Data de Pagamento:</strong>
                        <p style="font-size: 1em; color: #28a745; font-weight: 600;">{{ boleto.data_pagamento[:10] if boleto.data_pagamento|length > 10 else boleto.data_pagamento }}</p>
                    </div>
                    {% endif %}
                    {% if boleto.created_at %}
                    <div>
                        <strong style="color: #666; font-size: 0.9em; display: block; margin-bottom: 6px;">Criado em:</strong>
                        <p style="font-size: 1em; color: #666;">{{ boleto.created_at[:19] if boleto.created_at|length > 19 else boleto.created_at }}</p>
                    </div>
                    {% endif %}
                    {% if boleto.updated_at %}
                    <div>
                        <strong style="color: #666; font-size: 0.9em; display: block; margin-bottom: 6px;">Atualizado em:</strong>
                        <p style="font-size: 1em; color: #666;">{{ boleto.updated_at[:19] if boleto.updated_at|length > 19 else boleto.updated_at }}</p>
                    </div>
                    {% endif %}
                </div>
                
                {% if boleto.descricao %}
                <div style="padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <strong style="color: #666; font-size: 0.9em; display: block; margin-bottom: 8px;">Descri√ß√£o:</strong>
                    <p style="font-size: 1.05em; color: #333; line-height: 1.5;">{{ boleto.descricao }}</p>
                </div>
                {% endif %}
                
                {% if not boleto.esta_pago %}
                    {% if boleto.url_boleto_pdf %}
                    <div style="padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <strong style="color: #666; font-size: 0.9em; display: block; margin-bottom: 10px;">Download do Boleto:</strong>
                        <a href="{{ boleto.url_boleto_pdf }}" target="_blank" class="btn btn-pdf" style="text-decoration: none; display: inline-block;">
                            üìÑ Baixar Boleto em PDF
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if boleto.linha_digitavel %}
                    <div style="padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; flex-wrap: wrap; gap: 10px;">
                            <strong style="color: #666; font-size: 0.9em; flex: 1; min-width: 120px;">Linha Digit√°vel:</strong>
                            <button class="btn-copy" data-copy-text="{{ boleto.linha_digitavel }}" style="padding: 8px 16px; background: #E0367E; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s; flex-shrink: 0;" onmouseover="this.style.background='#c72d6a'" onmouseout="this.style.background='#E0367E'">Copiar</button>
                        </div>
                        <p class="copyable-text" data-copy-text="{{ boleto.linha_digitavel }}" style="font-size: 1.05em; color: #333; font-family: 'Courier New', monospace; word-break: break-all; letter-spacing: 1px; padding: 10px; background: #fafafa; border-radius: 8px; line-height: 1.6; margin: 0; cursor: pointer;" title="Clique para copiar">{{ boleto.linha_digitavel }}</p>
                    </div>
                    {% endif %}
                    
                    {% if boleto.pix_emv %}
                    <div style="padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; flex-wrap: wrap; gap: 10px;">
                            <strong style="color: #666; font-size: 0.9em; flex: 1; min-width: 120px;">PIX Copia e Cola:</strong>
                            <button class="btn-copy" data-copy-text="{{ boleto.pix_emv }}" style="padding: 8px 16px; background: #E0367E; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s; flex-shrink: 0;" onmouseover="this.style.background='#c72d6a'" onmouseout="this.style.background='#E0367E'">Copiar</button>
                        </div>
                        <p class="copyable-text" data-copy-text="{{ boleto.pix_emv }}" style="font-size: 0.95em; color: #333; font-family: 'Courier New', monospace; word-break: break-all; letter-spacing: 0.5px; padding: 10px; background: #fafafa; border-radius: 8px; line-height: 1.6; margin: 0; cursor: pointer;" title="Clique para copiar">{{ boleto.pix_emv }}</p>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Pagamento (apenas se n√£o estiver pago) -->
    {% if not boleto.esta_pago and boleto.payment_forms %}
    <div style="margin-top: 30px;">
        <h3 style="color: #E0367E; margin-bottom: 24px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; font-weight: 700;">üí≥ Pagamento</h3>
        <div style="display: flex; flex-direction: column; gap: 30px;">
            <!-- C√≥digo de Barras -->
            {% if boleto.barcode %}
            <div class="info-box">
                <h4 style="color: #333; margin-bottom: 16px; font-size: 1.2em; font-weight: 700;">C√≥digo de Barras</h4>
                <div style="padding: 20px; background: white; border-radius: 12px; border: 2px solid #f0f0f0;">
                    <div class="copyable-text" data-copy-text="{{ boleto.barcode }}" style="font-family: 'Courier New', monospace; font-size: 1.1em; word-break: break-all; text-align: center; color: #333; font-weight: 600; letter-spacing: 1px; padding: 16px; background: #fafafa; border-radius: 8px; cursor: pointer; overflow-x: auto;" title="Clique para copiar">
                        {{ boleto.barcode }}
                    </div>
                    <button class="btn-copy" data-copy-text="{{ boleto.barcode }}" style="margin-top: 12px; padding: 10px 20px; background: #E0367E; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; width: 100%; transition: all 0.3s;" onmouseover="this.style.background='#c72d6a'" onmouseout="this.style.background='#E0367E'">Copiar C√≥digo de Barras</button>
                </div>
            </div>
            {% endif %}
            
            <!-- Linha Digit√°vel -->
            {% for payment_form in boleto.payment_forms %}
                {% if payment_form.get('type') == 'BANK_SLIP' and (payment_form.get('digitable_line') or payment_form.get('digitableLine')) %}
                <div class="info-box">
                    <h4 style="color: #333; margin-bottom: 16px; font-size: 1.2em; font-weight: 700;">Linha Digit√°vel</h4>
                    <div style="padding: 20px; background: white; border-radius: 12px; border: 2px solid #f0f0f0;">
                        <div class="copyable-text" data-copy-text="{{ payment_form.digitable_line or payment_form.digitableLine }}" style="font-family: 'Courier New', monospace; font-size: 1.2em; word-break: break-all; text-align: center; color: #333; font-weight: 600; letter-spacing: 2px; padding: 16px; background: #fafafa; border-radius: 8px; cursor: pointer; overflow-x: auto;" title="Clique para copiar">
                            {{ payment_form.digitable_line or payment_form.digitableLine }}
                        </div>
                        <button class="btn-copy" data-copy-text="{{ payment_form.digitable_line or payment_form.digitableLine }}" style="margin-top: 12px; padding: 10px 20px; background: #E0367E; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; width: 100%; transition: all 0.3s;" onmouseover="this.style.background='#c72d6a'" onmouseout="this.style.background='#E0367E'">Copiar Linha Digit√°vel</button>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            
            <!-- PIX -->
            {% for payment_form in boleto.payment_forms %}
                {% if payment_form.get('type') == 'PIX' %}
                <div class="info-box">
                    <h4 style="color: #333; margin-bottom: 20px; font-size: 1.2em; font-weight: 700;">PIX</h4>
                    {% if payment_form.get('qr_code') %}
                    <div style="margin-bottom: 24px; text-align: center;">
                        <strong style="display: block; margin-bottom: 12px; font-size: 1em; color: #333; font-weight: 600;">QR Code</strong>
                        <img src="{{ payment_form.qr_code }}" alt="QR Code PIX" style="max-width: 300px; width: 100%; border: 3px solid #f0f0f0; border-radius: 16px; padding: 20px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    </div>
                    {% endif %}
                    {% if payment_form.get('qr_code_text') %}
                    <div>
                        <strong style="display: block; margin-bottom: 12px; font-size: 1em; color: #333; font-weight: 600;">PIX Copia e Cola</strong>
                        <div style="padding: 20px; background: white; border-radius: 12px; border: 2px solid #f0f0f0;">
                            <div class="copyable-text" data-copy-text="{{ payment_form.qr_code_text }}" style="font-family: 'Courier New', monospace; font-size: 0.95em; word-break: break-all; text-align: center; color: #333; letter-spacing: 0.5px; padding: 16px; background: #fafafa; border-radius: 8px; line-height: 1.6; cursor: pointer; overflow-x: auto;" title="Clique para copiar">
                                {{ payment_form.qr_code_text }}
                            </div>
                            <button class="btn-copy" data-copy-text="{{ payment_form.qr_code_text }}" style="margin-top: 12px; padding: 10px 20px; background: #E0367E; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; width: 100%; transition: all 0.3s;" onmouseover="this.style.background='#c72d6a'" onmouseout="this.style.background='#E0367E'">Copiar C√≥digo PIX</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
// Fun√ß√£o moderna de copiar para √°rea de transfer√™ncia com fallback
async function copyToClipboard(text) {
    // Tentar usar a API moderna do Clipboard (mais confi√°vel)
    if (navigator.clipboard && window.isSecureContext) {
        try {
            await navigator.clipboard.writeText(text);
            showCopyFeedback('Copiado para a √°rea de transfer√™ncia!');
            return true;
        } catch (err) {
            console.error('Erro ao copiar com Clipboard API:', err);
            // Continuar para o fallback
        }
    }
    
    // Fallback para navegadores antigos ou contextos n√£o seguros
    try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-999999px';
        textarea.style.top = '-999999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
            showCopyFeedback('Copiado para a √°rea de transfer√™ncia!');
            return true;
        } else {
            throw new Error('execCommand retornou false');
        }
    } catch (err) {
        console.error('Erro ao copiar:', err);
        showCopyFeedback('Erro ao copiar. Tente selecionar o texto manualmente.', true);
        return false;
    }
}

// Fun√ß√£o para mostrar feedback visual ao copiar
function showCopyFeedback(message, isError = false) {
    // Criar elemento de feedback
    const feedback = document.createElement('div');
    feedback.textContent = message;
    feedback.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${isError ? '#dc2626' : '#16a34a'};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 600;
        font-size: 0.95em;
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
    `;
    
    // Adicionar anima√ß√£o CSS se n√£o existir
    if (!document.getElementById('copy-feedback-style')) {
        const style = document.createElement('style');
        style.id = 'copy-feedback-style';
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(feedback);
    
    // Remover ap√≥s 3 segundos
    setTimeout(() => {
        feedback.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 300);
    }, 3000);
}

// Adicionar event listeners para todos os bot√µes de copiar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    // Bot√µes de copiar
    const copyButtons = document.querySelectorAll('.btn-copy');
    
    copyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const textToCopy = this.getAttribute('data-copy-text');
            if (textToCopy) {
                copyToClipboard(textToCopy);
            } else {
                console.error('Texto n√£o encontrado no atributo data-copy-text');
                showCopyFeedback('Erro: texto n√£o encontrado', true);
            }
        });
    });
    
    // Elementos de texto clic√°veis para copiar
    const copyableTexts = document.querySelectorAll('.copyable-text');
    
    copyableTexts.forEach(element => {
        element.addEventListener('click', function() {
            const textToCopy = this.getAttribute('data-copy-text');
            if (textToCopy) {
                // Selecionar o texto visualmente
                if (window.getSelection) {
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(this);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                
                // Copiar usando a fun√ß√£o moderna
                copyToClipboard(textToCopy);
            }
        });
        
        // Adicionar efeito hover
        element.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f0f0f0';
        });
        
        element.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#fafafa';
        });
    });
});
</script>
{% endblock %}
